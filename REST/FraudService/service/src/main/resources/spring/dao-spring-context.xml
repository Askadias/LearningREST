<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns='http://www.springframework.org/schema/beans'
       xmlns:context='http://www.springframework.org/schema/context'
       xmlns:xsi='http://www.w3.org/2001/XMLSchema-instance'
       xmlns:p="http://www.springframework.org/schema/p"
       xmlns:c="http://www.springframework.org/schema/c"
       xmlns:mongo='http://www.springframework.org/schema/data/mongo'
       xsi:schemaLocation="
        http://www.springframework.org/schema/beans         http://www.springframework.org/schema/beans/spring-beans.xsd
        http://www.springframework.org/schema/data/mongo    http://www.springframework.org/schema/data/mongo/spring-mongo.xsd
        http://www.springframework.org/schema/context       http://www.springframework.org/schema/context/spring-context.xsd">

    <!-- =========================================================================================
                                   Mongo Data Source
    ========================================================================================== -->
    <context:annotation-config/>
    <context:component-scan base-package='ru.forxy.fraud.rest.v1.check'/>

    <mongo:mongo id="mongo" host='${ru.forxy.fraud.MongoTemplate/host}' port='${ru.forxy.fraud.MongoTemplate/port}'>
        <mongo:options
                connections-per-host='${ru.forxy.fraud.MongoTemplate/connections}'
                connect-timeout='${ru.forxy.fraud.MongoTemplate/timeout}'
                max-wait-time='${ru.forxy.fraud.MongoTemplate/maxWait}'
                write-number='${ru.forxy.fraud.MongoTemplate/writeNumber}'
                write-timeout='${ru.forxy.fraud.MongoTemplate/writeTimeout}'
                write-fsync='${ru.forxy.fraud.MongoTemplate/writeFSync}'/>
    </mongo:mongo>

    <mongo:db-factory id="factory" dbname='fraud' mongo-ref='mongo'/>

    <mongo:repositories base-package='ru.forxy.fraud.db.dao.mongo'/>


    <bean id="mappingContext" class="org.springframework.data.mongodb.core.mapping.MongoMappingContext">
        <property name="fieldNamingStrategy">
            <bean class="org.springframework.data.mongodb.core.mapping.SnakeCaseFieldNamingStrategy"/>
        </property>
    </bean>

    <bean id="defaultMongoTypeMapper" class="org.springframework.data.mongodb.core.convert.DefaultMongoTypeMapper">
        <constructor-arg name="typeKey">
            <null/>
        </constructor-arg>
    </bean>

    <bean id="mappingMongoConverter" class="org.springframework.data.mongodb.core.convert.MappingMongoConverter">
        <constructor-arg name="mongoDbFactory" ref="factory"/>
        <constructor-arg name="mappingContext" ref="mappingContext"/>
        <property name="typeMapper" ref="defaultMongoTypeMapper"/>
    </bean>

    <bean id="mongoTemplate" class="org.springframework.data.mongodb.core.MongoTemplate">
        <constructor-arg name="mongoDbFactory" ref="factory"/>
        <constructor-arg name="mongoConverter" ref="mappingMongoConverter"/>
    </bean>

    <bean id="transactionDAO.impl.mongo" class="ru.forxy.fraud.db.dao.mongo.TransactionDAO"
          autowire-candidate="false"
          p:mongoTemplate-ref="mongoTemplate"/>


    <!-- =========================================================================================
                                   Cassandra Data Source
    ========================================================================================== -->

    <bean id="cassandraClusterBuilder" class="com.datastax.driver.core.Cluster" factory-method="builder"/>
    <bean id="cassandraClusterBuilder.withHost" factory-bean="cassandraClusterBuilder" factory-method="addContactPoint"
          c:address="${cassandra.nodes}"/>

    <bean id="cassandraCluster" factory-bean="cassandraClusterBuilder.withHost" factory-method="build"/>

    <bean id="cassandraSession" factory-bean="cassandraCluster" factory-method="connect"/>

    <bean id="mappingSession" class="com.datastax.driver.mapping.MappingSession"
          c:keyspace="${cassandra.keyspace}"
          c:session-ref="cassandraSession"/>

    <bean id="blackListDAO.impl.cassandra" class="ru.forxy.fraud.db.dao.cassandra.BlackListDAO"
          p:mappingSession-ref="mappingSession"/>

</beans>
