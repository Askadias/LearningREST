<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns='http://www.springframework.org/schema/beans'
       xmlns:xsi='http://www.w3.org/2001/XMLSchema-instance'
       xmlns:p="http://www.springframework.org/schema/p"
       xmlns:c="http://www.springframework.org/schema/c"
       xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd">

    <bean id="ru.forxy.common.support.Configuration.performance" class="ru.forxy.common.support.Configuration">
        <property name="settings">
            <map key-type="java.lang.Object" value-type="java.lang.String">
                <entry key="#{T(ru.forxy.common.logging.LoggingServletFilter$Configs).IsHttpInfoLoggingEnabled}"
                       value="true"/>
                <entry key="#{T(ru.forxy.common.logging.AbstractPerformanceLogger$Configs).IsPayloadLoggingEnabled}"
                       value="true"/>
                <entry key="#{T(ru.forxy.common.logging.AbstractPerformanceLogger$Configs).IsPerformanceLoggingEnabled}"
                       value="true"/>
            </map>
        </property>
    </bean>

    <!-- ================= SERVICE ================================================================================= -->

    <bean id="ru.forxy.common.support.Configuration.performance.endpoint" class="ru.forxy.common.support.Configuration"
          parent="ru.forxy.common.support.Configuration.performance">
        <property name="settings">
            <map key-type="java.lang.Object" value-type="java.lang.String" merge="true">
                <entry key="#{T(ru.forxy.common.logging.support.Fields).ActivityName}" value="endpoint"/>
            </map>
        </property>
    </bean>

    <bean id="performance.logger.request"
          class="ru.forxy.common.logging.writer.LogWriter" c:name="fraud.performance.request"/>
    <bean id="performance.logger.response"
          class="ru.forxy.common.logging.writer.LogWriter" c:name="fraud.performance.response"/>

    <bean id="performance.loggingFilter"
          class="ru.forxy.common.logging.LoggingServletFilter"
          p:configuration-ref="ru.forxy.common.support.Configuration.performance.endpoint"
          p:requestWriter-ref="performance.logger.request"
          p:responseWriter-ref="performance.logger.response">
        <property name="requestFieldExtractors">
            <bean class="ru.forxy.common.logging.extractor.SpringELFieldExtractor">
                <property name="extractRules">
                    <map>
                        <entry key="Client"
                               value="#request.getParameter('client_id')?:#requestHeaders['client-id']?:null"/>
                        <entry key="TransactionGUID"
                               value="#request.getParameter('transaction_guid')?:#requestHeaders['transaction-guid']?:null"/>
                        <entry key="MessageGUID"
                               value="#request.getParameter('message_guid')?:#requestHeaders['message-guid']?:null"/>
                        <entry key="OperationName" value="#request.requestURI.matches('.*/velocity/?') and #request.getMethod().equals('POST') ? 'VelocityCheck' :
                                #request.requestURI.matches('.*/velocity/metrics/[?metric_type=\w+&amp;metric_value=\w+]?') and #request.getMethod().equals('GET') ? 'GetVelocityMetrics' :
                                #request.requestURI.matches('.*/velocity/data_list/[?metric_type=\w+&amp;metric_value=\w+].*') and #request.getMethod().equals('GET') ? 'GetVelocityDataLog' :
                                #request.requestURI.matches('.*/velocity/metric/[?metric_type=\w+&amp;metric_value=\w+]?') and #request.getMethod().equals('GET') ? 'GetVelocityMetric' :
                                #request.requestURI.matches('.*/velocity/data/[?metric_type=\w+&amp;metric_value=\w+]?') and #request.getMethod().equals('GET') ? 'GetVelocityData' :
                                null"/>
                    </map>
                </property>
            </bean>
        </property>
        <property name="responseFieldExtractors">
            <bean class="ru.forxy.common.logging.extractor.SpringELFieldExtractor">
                <property name="extractRules">
                    <map>
                        <entry key="TransactionGUID" value="#responseHeaders['Transaction-GUID']"/>
                        <entry key="MessageGUID" value="#responseHeaders['Message-GUID']"/>
                        <entry key="StatusCode">
                            <value>(#response.responseStatus==200 or #response.responseStatus==201 or
                                #response.responseStatus==204) ? '0' :
                                #response.responseStatus==400 ? '-1' :
                                #response.responseStatus==500 ? #payload.replaceAll('.*?"code":\s*"?(\d+).*','$1') :
                                #response.responseStatus
                            </value>
                        </entry>
                    </map>
                </property>
            </bean>
        </property>
    </bean>

    <!-- ================= DAO ===================================================================================== -->

    <bean id="configuration.performance.dao" class="ru.forxy.common.support.Configuration"
          parent="ru.forxy.common.support.Configuration.performance"/>

    <bean id="databaseExceptionHandler"
          class="ru.forxy.common.logging.exceptions.DatabaseExceptionHandler"
          p:databaseHost="${ru.forxy.fraud.MongoTemplate/host}:${ru.forxy.fraud.MongoTemplate/port}"/>

    <bean id="ru.forxy.fraud.performance.logger.dao"
          class="ru.forxy.common.logging.writer.LogWriter" c:name="user.performance.dao"/>

    <bean id="performance.dao.loggingInterceptor"
          class="ru.forxy.common.logging.LoggingInterceptor"
          p:configuration-ref="configuration.performance.dao"
          p:responseWriter-ref="ru.forxy.fraud.performance.logger.dao"
          p:exceptionHandler-ref="databaseExceptionHandler"/>

    <bean id="transactionDAO.mongo.perf" class="org.springframework.aop.framework.ProxyFactoryBean"
          autowire-candidate="false"
          p:proxyInterfaces="ru.forxy.fraud.db.dao.ITransactionDAO"
          p:target-ref="transactionDAO.impl.mongo">
        <property name="interceptorNames">
            <list>
                <idref bean="performance.dao.loggingInterceptor"/>
            </list>
        </property>
    </bean>

    <bean id="velocityConfigDAO.mongo.perf" class="org.springframework.aop.framework.ProxyFactoryBean"
          autowire-candidate="false"
          p:proxyInterfaces="ru.forxy.fraud.db.dao.IVelocityConfigDAO"
          p:target-ref="velocityConfigDAO.impl.mongo">
        <property name="interceptorNames">
            <list>
                <idref bean="performance.dao.loggingInterceptor"/>
            </list>
        </property>
    </bean>

    <bean id="blackListDAO.cassandra.perf" class="org.springframework.aop.framework.ProxyFactoryBean"
          autowire-candidate="false"
          p:proxyInterfaces="ru.forxy.fraud.db.dao.IBlackListDAO"
          p:target-ref="blackListDAO.impl.cassandra">
        <property name="interceptorNames">
            <list>
                <idref bean="performance.dao.loggingInterceptor"/>
            </list>
        </property>
    </bean>

    <bean id="velocityDAO.cassandra.perf" class="org.springframework.aop.framework.ProxyFactoryBean"
          autowire-candidate="false"
          p:proxyInterfaces="ru.forxy.fraud.db.dao.IVelocityDAO"
          p:target-ref="velocityDAO.impl.cassandra">
        <property name="interceptorNames">
            <list>
                <idref bean="performance.dao.loggingInterceptor"/>
            </list>
        </property>
    </bean>

    <!-- ================= IMPLEMENTATION ========================================================================== -->

    <bean id="configuration.performance.impl" class="ru.forxy.common.support.Configuration"
          parent="ru.forxy.common.support.Configuration.performance"/>

    <bean id="serviceExceptionHandler"
          class="ru.forxy.common.logging.exceptions.ServiceExceptionHandler"/>

    <bean id="performance.logger.impl"
          class="ru.forxy.common.logging.writer.LogWriter" c:name="fraud.performance.velocity.impl"/>

    <bean id="impl.loggingInterceptor"
          class="ru.forxy.common.logging.LoggingInterceptor"
          p:configuration-ref="configuration.performance.impl"
          p:responseWriter-ref="performance.logger.impl"
          p:exceptionHandler-ref="serviceExceptionHandler"/>

    <bean id="fraudServiceFacade.perf" class="org.springframework.aop.framework.ProxyFactoryBean"
          autowire-candidate="false"
          p:proxyInterfaces="ru.forxy.fraud.logic.IFraudServiceFacade"
          p:target-ref="fraudServiceFacade.impl">
        <property name="interceptorNames">
            <list>
                <idref bean="impl.loggingInterceptor"/>
            </list>
        </property>
    </bean>

    <bean id="blackListManager.perf" class="org.springframework.aop.framework.ProxyFactoryBean"
          autowire-candidate="false"
          p:proxyInterfaces="ru.forxy.fraud.logic.blacklist.IBlackListManager"
          p:target-ref="blackListManager.impl">
        <property name="interceptorNames">
            <list>
                <idref bean="impl.loggingInterceptor"/>
            </list>
        </property>
    </bean>

    <bean id="velocityManager.perf" class="org.springframework.aop.framework.ProxyFactoryBean"
          autowire-candidate="false"
          p:proxyInterfaces="ru.forxy.fraud.logic.velocity.IVelocityManager"
          p:target-ref="velocityManager.impl">
        <property name="interceptorNames">
            <list>
                <idref bean="impl.loggingInterceptor"/>
            </list>
        </property>
    </bean>

    <bean id="velocityConfigManager.perf" class="org.springframework.aop.framework.ProxyFactoryBean"
          autowire-candidate="false"
          p:proxyInterfaces="ru.forxy.fraud.logic.velocity.IVelocityConfigManager"
          p:target-ref="velocityConfigManager.impl">
        <property name="interceptorNames">
            <list>
                <idref bean="impl.loggingInterceptor"/>
            </list>
        </property>
    </bean>
</beans>
